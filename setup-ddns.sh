#!/bin/bash

# Dynamic DNS Setup Script for Cloudflare
# Usage: ./setup-ddns.sh

echo "ğŸŒ Dynamic DNS Setup for pre-trading-approval.inspirationcap.com"
echo "============================================================="
echo ""

# Check if required tools are installed
if ! command -v curl &> /dev/null; then
    echo "âŒ curl not found. Please install curl first."
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "ğŸ“¦ jq not found. Installing jq..."
    if command -v apt-get &> /dev/null; then
        sudo apt-get update && sudo apt-get install -y jq
    elif command -v yum &> /dev/null; then
        sudo yum install -y jq
    else
        echo "âŒ Please install jq manually"
        exit 1
    fi
fi

echo "âœ… Prerequisites installed"
echo ""

# Prompt for Cloudflare credentials
echo "ğŸ“‹ Please provide your Cloudflare details:"
echo ""
read -p "Cloudflare API Token (with Zone:Edit permissions): " API_TOKEN
read -p "Zone ID (from Cloudflare dashboard): " ZONE_ID
read -p "Domain (default: pre-trading-approval.inspirationcap.com): " DOMAIN

# Set default domain if empty
DOMAIN=${DOMAIN:-pre-trading-approval.inspirationcap.com}

echo ""
echo "ğŸ” Finding DNS record..."

# Get record ID
RECORD_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$DOMAIN" \
     -H "Authorization: Bearer $API_TOKEN" \
     -H "Content-Type: application/json")

RECORD_ID=$(echo $RECORD_RESPONSE | jq -r '.result[0].id // empty')

if [ -z "$RECORD_ID" ] || [ "$RECORD_ID" = "null" ]; then
    echo "âš ï¸  DNS record not found. Creating new A record..."
    
    # Get current public IP
    CURRENT_IP=$(curl -s https://ipv4.icanhazip.com)
    echo "ğŸŒ Current public IP: $CURRENT_IP"
    
    # Create DNS record
    CREATE_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
         -H "Authorization: Bearer $API_TOKEN" \
         -H "Content-Type: application/json" \
         --data "{\"type\":\"A\",\"name\":\"$DOMAIN\",\"content\":\"$CURRENT_IP\",\"ttl\":300}")
    
    RECORD_ID=$(echo $CREATE_RESPONSE | jq -r '.result.id // empty')
    
    if [ -z "$RECORD_ID" ] || [ "$RECORD_ID" = "null" ]; then
        echo "âŒ Failed to create DNS record"
        echo "Response: $CREATE_RESPONSE"
        exit 1
    fi
    
    echo "âœ… DNS record created with ID: $RECORD_ID"
else
    echo "âœ… DNS record found with ID: $RECORD_ID"
fi

echo ""
echo "ğŸ“ Creating DDNS update script..."

# Create the update script
cat > update-cloudflare-dns.sh << EOF
#!/bin/bash

# Cloudflare DDNS Update Script
# Auto-generated by setup-ddns.sh

ZONE_ID="$ZONE_ID"
RECORD_ID="$RECORD_ID"
API_TOKEN="$API_TOKEN"
DOMAIN="$DOMAIN"

# Get current public IP
CURRENT_IP=\$(curl -s https://ipv4.icanhazip.com)

if [ -z "\$CURRENT_IP" ]; then
    echo "\$(date): Failed to get current IP" >> /tmp/ddns.log
    exit 1
fi

# Get current DNS record
DNS_IP=\$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/\$ZONE_ID/dns_records/\$RECORD_ID" \\
     -H "Authorization: Bearer \$API_TOKEN" \\
     -H "Content-Type: application/json" | jq -r '.result.content // empty')

# Update only if IP has changed
if [ "\$CURRENT_IP" != "\$DNS_IP" ]; then
    echo "\$(date): IP changed from \$DNS_IP to \$CURRENT_IP" >> /tmp/ddns.log
    
    # Update Cloudflare DNS
    RESPONSE=\$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/\$ZONE_ID/dns_records/\$RECORD_ID" \\
         -H "Authorization: Bearer \$API_TOKEN" \\
         -H "Content-Type: application/json" \\
         --data "{\\"type\\":\\"A\\",\\"name\\":\\"\$DOMAIN\\",\\"content\\":\\"\$CURRENT_IP\\",\\"ttl\\":300}")
    
    SUCCESS=\$(echo \$RESPONSE | jq -r '.success // false')
    
    if [ "\$SUCCESS" = "true" ]; then
        echo "\$(date): Successfully updated \$DOMAIN to \$CURRENT_IP" >> /tmp/ddns.log
    else
        echo "\$(date): Failed to update DNS: \$RESPONSE" >> /tmp/ddns.log
    fi
else
    echo "\$(date): IP unchanged (\$CURRENT_IP)" >> /tmp/ddns.log
fi
EOF

chmod +x update-cloudflare-dns.sh

echo "âœ… DDNS update script created: update-cloudflare-dns.sh"
echo ""

# Test the script
echo "ğŸ§ª Testing DDNS update..."
./update-cloudflare-dns.sh

if [ $? -eq 0 ]; then
    echo "âœ… DDNS test successful"
else
    echo "âŒ DDNS test failed. Check /tmp/ddns.log"
    exit 1
fi

echo ""
echo "â° Setting up automatic updates..."

# Add to crontab
CRON_JOB="*/5 * * * * $(pwd)/update-cloudflare-dns.sh"

# Check if cron job already exists
if crontab -l 2>/dev/null | grep -q "update-cloudflare-dns.sh"; then
    echo "âš ï¸  Cron job already exists"
else
    # Add to crontab
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    echo "âœ… Cron job added (updates every 5 minutes)"
fi

echo ""
echo "ğŸ‰ DDNS Setup Complete!"
echo ""
echo "ğŸ“‹ Summary:"
echo "   â€¢ Domain: $DOMAIN"
echo "   â€¢ Current IP: $(curl -s https://ipv4.icanhazip.com)"
echo "   â€¢ Update script: $(pwd)/update-cloudflare-dns.sh"
echo "   â€¢ Log file: /tmp/ddns.log"
echo "   â€¢ Update frequency: Every 5 minutes"
echo ""
echo "ğŸ”§ Management Commands:"
echo "   â€¢ Manual update: ./update-cloudflare-dns.sh"
echo "   â€¢ View log: tail -f /tmp/ddns.log"
echo "   â€¢ Test DNS: nslookup $DOMAIN"
echo ""
echo "ğŸŒ Your domain will automatically update when your IP changes!"
echo ""
echo "ğŸš€ Now run: ./deploy-nas.sh to deploy your application"